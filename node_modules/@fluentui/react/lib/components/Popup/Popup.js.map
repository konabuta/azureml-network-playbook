{"version":3,"file":"Popup.js","sourceRoot":"../src/","sources":["components/Popup/Popup.tsx"],"names":[],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport {\n  KeyCodes,\n  divProperties,\n  doesElementContainFocus,\n  getDocument,\n  getNativeProps,\n  getWindow,\n} from '../../Utilities';\nimport { IPopupProps, IPopupRestoreFocusParams } from './Popup.types';\nimport { useMergedRefs, useAsync, useOnEvent } from '@fluentui/react-hooks';\nimport { useWindow } from '@fluentui/react-window-provider';\n\nfunction useScrollbarAsync(props: IPopupProps, root: React.RefObject<HTMLDivElement | undefined>) {\n  const async = useAsync();\n  const [needsVerticalScrollBarState, setNeedsVerticalScrollBar] = React.useState(false);\n  React.useEffect(() => {\n    async.requestAnimationFrame(() => {\n      // If overflowY is overridden, don't waste time calculating whether the scrollbar is necessary.\n      if (props.style && props.style.overflowY) {\n        return;\n      }\n\n      let needsVerticalScrollBar = false;\n      if (root && root.current && root.current?.firstElementChild) {\n        // ClientHeight returns the client height of an element rounded to an\n        // integer. On some browsers at different zoom levels this rounding\n        // can generate different results for the root container and child even\n        // though they are the same height. This causes us to show a scroll bar\n        // when not needed. Ideally we would use BoundingClientRect().height\n        // instead however seems that the API is 90% slower than using ClientHeight.\n        // Therefore instead we will calculate the difference between heights and\n        // allow for a 1px difference to still be considered ok and not show the\n        // scroll bar.\n        const rootHeight = root.current.clientHeight;\n        const firstChildHeight = root.current.firstElementChild.clientHeight;\n        if (rootHeight > 0 && firstChildHeight > rootHeight) {\n          needsVerticalScrollBar = firstChildHeight - rootHeight > 1;\n        }\n      }\n      if (needsVerticalScrollBarState !== needsVerticalScrollBar) {\n        setNeedsVerticalScrollBar(needsVerticalScrollBar);\n      }\n    });\n\n    return () => async.dispose();\n  });\n\n  return needsVerticalScrollBarState;\n}\n\nfunction defaultFocusRestorer(options: IPopupRestoreFocusParams) {\n  const { originalElement, containsFocus } = options;\n\n  if (originalElement && containsFocus && originalElement !== getWindow()) {\n    // Make sure that the focus method actually exists\n    // In some cases the object might exist but not be a real element.\n    // This is primarily for IE 11 and should be removed once IE 11 is no longer in use.\n    // This is wrapped in a setTimeout because of a React 16 bug that is resolved in 17.\n    // Once we move to 17, the setTimeout should be removed (ref: https://github.com/facebook/react/issues/17894#issuecomment-656094405)\n    setTimeout(() => {\n      originalElement.focus?.();\n    }, 0);\n  }\n}\n\nfunction useRestoreFocus(props: IPopupProps, root: React.RefObject<HTMLDivElement | undefined>) {\n  const { onRestoreFocus = defaultFocusRestorer } = props;\n  const originalFocusedElement = React.useRef<HTMLElement>();\n  const containsFocus = React.useRef(false);\n\n  React.useEffect(() => {\n    originalFocusedElement.current = getDocument()!.activeElement as HTMLElement;\n\n    if (doesElementContainFocus(root.current!)) {\n      containsFocus.current = true;\n    }\n\n    return () => {\n      onRestoreFocus?.({\n        originalElement: originalFocusedElement.current,\n        containsFocus: containsFocus.current,\n        documentContainsFocus: getDocument()?.hasFocus() || false,\n      });\n\n      // De-reference DOM Node to avoid retainment via transpiled closure of _onKeyDown\n      originalFocusedElement.current = undefined;\n    };\n\n    // eslint-disable-next-line react-hooks/exhaustive-deps -- should only run on first render\n  }, []);\n\n  useOnEvent(\n    root,\n    'focus',\n    React.useCallback((): void => {\n      containsFocus.current = true;\n    }, []),\n    true,\n  );\n\n  useOnEvent(\n    root,\n    'blur',\n    React.useCallback((ev: FocusEvent): void => {\n      /** The popup should update this._containsFocus when:\n       * relatedTarget exists AND\n       * the relatedTarget is not contained within the popup.\n       * If the relatedTarget is within the popup, that means the popup still has focus\n       * and focused moved from one element to another within the popup.\n       * If relatedTarget is undefined or null that usually means that a\n       * keyboard event occurred and focus didn't change\n       */\n      if (root.current && ev.relatedTarget && !root.current.contains(ev.relatedTarget as HTMLElement)) {\n        containsFocus.current = false;\n      }\n      // eslint-disable-next-line react-hooks/exhaustive-deps -- should only run on first render\n    }, []),\n    true,\n  );\n}\n\n/**\n * This adds accessibility to Dialog and Panel controls\n */\nexport const Popup: React.FunctionComponent<IPopupProps> = React.forwardRef<HTMLDivElement, IPopupProps>(\n  (props, forwardedRef) => {\n    // Default props\n    // eslint-disable-next-line deprecation/deprecation\n    props = { shouldRestoreFocus: true, ...props };\n\n    const root = React.useRef<HTMLDivElement>();\n    const mergedRootRef = useMergedRefs(root, forwardedRef) as React.Ref<HTMLDivElement>;\n\n    useRestoreFocus(props, root);\n\n    const { role, className, ariaLabel, ariaLabelledBy, ariaDescribedBy, style, children, onDismiss } = props;\n    const needsVerticalScrollBar = useScrollbarAsync(props, root);\n\n    const onKeyDown = React.useCallback(\n      (ev: React.KeyboardEvent<HTMLElement> | KeyboardEvent): void => {\n        // eslint-disable-next-line deprecation/deprecation\n        switch (ev.which) {\n          case KeyCodes.escape:\n            if (onDismiss) {\n              onDismiss(ev);\n\n              ev.preventDefault();\n              ev.stopPropagation();\n            }\n\n            break;\n        }\n      },\n      [onDismiss],\n    );\n\n    const win = useWindow();\n    useOnEvent(win, 'keydown', onKeyDown as (ev: Event) => void);\n\n    return (\n      <div\n        ref={mergedRootRef}\n        {...getNativeProps(props, divProperties)}\n        className={className}\n        role={role}\n        aria-label={ariaLabel}\n        aria-labelledby={ariaLabelledBy}\n        aria-describedby={ariaDescribedBy}\n        onKeyDown={onKeyDown}\n        style={{ overflowY: needsVerticalScrollBar ? 'scroll' : undefined, outline: 'none', ...style }}\n      >\n        {children}\n      </div>\n    );\n  },\n);\n"]}